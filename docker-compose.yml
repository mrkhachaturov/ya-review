services:
  postgres:
    image: pgvector/pgvector:pg17
    environment:
      POSTGRES_DB: yarev
      POSTGRES_USER: yarev
      POSTGRES_PASSWORD: ${PG_PASSWORD:-yarev_dev}
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "${PG_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U yarev -d yarev"]
      interval: 5s
      timeout: 5s
      retries: 5

  yarev:
    build: .
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      YAREV_DB_URL: postgresql://yarev:${PG_PASSWORD:-yarev_dev}@postgres:5432/yarev
      YAREV_OPENAI_API_KEY: ${YAREV_OPENAI_API_KEY}
      YAREV_CONFIG: /app/config.yaml
      DAEMON_CRON: ${DAEMON_CRON:-0 8 * * *}
      EMBED_CRON: ${EMBED_CRON:-0 2 * * *}
    volumes:
      - ${YAREV_CONFIG_PATH:-./config.example.yaml}:/app/config.yaml:ro
    restart: unless-stopped

volumes:
  pgdata:

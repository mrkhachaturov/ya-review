# Алгоритм AI-скоринга

[English version](scoring-algorithm.md)

## Обзор

Система скоринга yarev анализирует отзывы в три этапа:

```
Отзывы → [Эмбеддинги] → [Классификация] → [Скоринг]
          (OpenAI)        (локально)        (локально)
```

Только первый этап (эмбеддинги) обращается к внешнему API. Классификация и скоринг выполняются полностью локально на вашей машине.

## Этап 1: Эмбеддинги (`yarev embed`)

Текст каждого отзыва и название каждой темы отправляются в модель OpenAI `text-embedding-3-small`, которая возвращает вектор из 1536 чисел — «смысловой отпечаток» текста.

```
"Отличный ремонт, быстро и качественно" → [0.023, -0.041, 0.018, ...] (1536 чисел)
"Качество ремонта"                       → [0.031, -0.015, 0.042, ...]
```

Тексты с похожим смыслом дают похожие вектора. Вектора хранятся локально в SQLite как Float32-блобы.

**Стоимость:** ~$0.02 за 1М токенов (~$0.01 за 1000 отзывов).

## Этап 2: Классификация (`yarev classify`)

Для каждого отзыва вычисляется [косинусное сходство](https://ru.wikipedia.org/wiki/Косинусное_сходство) между вектором отзыва и вектором каждой подтемы:

```
cosine("Отличный ремонт, быстро", "Качество ремонта")    = 0.82 ✅ совпадение
cosine("Отличный ремонт, быстро", "Зона ожидания")        = 0.31 ✅ слабое совпадение
cosine("Отличный ремонт, быстро", "Наценка на запчасти")  = 0.18 ❌ ниже порога
```

**Параметры:**
- **Порог:** 0.3 (минимальное сходство для привязки к теме)
- **Макс. тем на отзыв:** 3 (один отзыв может относиться к нескольким темам)

Один отзыв может быть привязан к нескольким подтемам (до 3). Отзывы без текста пропускаются.

## Этап 3: Скоринг (`yarev score`)

Никакого AI — чистая математика на основе звёзд и дат.

### Шаг 3а: Звёзды → Оценка (шкала 2-10)

Звёзды линейно преобразуются в шкалу 2-10:

| Звёзды | Оценка |
|--------|--------|
| 1 ★    | 2.0    |
| 2 ★★   | 4.0    |
| 3 ★★★  | 6.0    |
| 4 ★★★★ | 8.0    |
| 5 ★★★★★ | 10.0  |

**Формула:** `оценка = звёзды × 2`

### Шаг 3б: Вес по давности

Свежие отзывы важнее. Каждый отзыв получает вес в зависимости от возраста:

| Возраст отзыва | Вес  |
|----------------|------|
| < 6 месяцев    | 2.0× |
| 6–12 месяцев   | 1.5× |
| > 12 месяцев   | 1.0× |

### Шаг 3в: Средневзвешенная оценка

Оценка темы — средневзвешенное значение:

```
оценка_темы = Σ(оценка_i × вес_i) / Σ(вес_i)
```

**Пример — тема «Качество ремонта» с 4 отзывами:**

| Отзыв          | Звёзды | Оценка | Возраст  | Вес  | Оценка × Вес |
|----------------|--------|--------|----------|------|--------------|
| Отзыв А        | 5      | 10.0   | 2 месяца | 2.0  | 20.0         |
| Отзыв Б        | 4      | 8.0    | 1 месяц  | 2.0  | 16.0         |
| Отзыв В        | 3      | 6.0    | 8 месяцев| 1.5  | 9.0          |
| Отзыв Г        | 5      | 10.0   | 2 года   | 1.0  | 10.0         |
| **Итого**      |        |        |          |**6.5**| **55.0**    |

**Оценка темы = 55.0 / 6.5 = 8.5**

### Шаг 3г: Агрегация родительских тем

Родительские темы агрегируют свои подтемы по количеству отзывов:

```
оценка_родителя = Σ(оценка_подтемы × кол-во_отзывов_подтемы) / Σ(кол-во_отзывов_подтемы)
```

### Шаг 3д: Уровень уверенности

Зависит от количества классифицированных отзывов по теме:

| Отзывов | Уверенность | Значение |
|---------|-------------|----------|
| < 5     | low         | Мало данных, оценка может быть ненадёжной |
| 5–19    | medium      | Разумная оценка |
| 20+     | high        | Статистически надёжная |

### Шаг 3е: Общая оценка компании

Та же средневзвешенная по всем родительским темам:

```
общая_оценка = Σ(оценка_темы × кол-во_отзывов_темы) / Σ(кол-во_отзывов_темы)
```

## Режим сравнения (`yarev score --compare`)

При сравнении двух компаний:
- Обе оцениваются независимо по одному алгоритму
- Вычисляется разница по каждой теме: `Δ = оценка_A − оценка_B`
- Маркеры показывают значимые отличия:
  - ✅ когда ваша оценка выше на ≥ 0.5
  - ❌ когда ваша оценка ниже на ≥ 0.5

## Исходный код

| Компонент | Файл |
|-----------|------|
| Клиент эмбеддингов | `src/embeddings/client.ts` |
| Векторная математика | `src/embeddings/vectors.ts` |
| Классификация | `src/embeddings/classify.ts` |
| Скоринг | `src/embeddings/scoring.ts` |
| Команда score | `src/cli/score.ts` |
